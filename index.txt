‚Äã<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Sistema de Asistencia de Obra - 2026</title>
    <style>
        :root { --festivo-bg: #fff9c4; --header-bg: #1a252f; --texto-negro: #000000; --azul-btn: #2196F3; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; color: var(--texto-negro); background: #f4f7f6; }
        
        /* Sistema de Pesta√±as */
        .tabs-nav { background: #1a252f; padding: 10px 20px 0; display: flex; gap: 5px; }
        .tab-btn { 
            padding: 10px 25px; border: none; background: #34495e; color: white; 
            cursor: pointer; border-radius: 8px 8px 0 0; font-weight: bold; transition: 0.3s;
        }
        .tab-btn.active { background: #f4f7f6; color: #1a252f; }
        .tab-content { display: none; padding: 20px; }
        .tab-content.active { display: block; }

        /* Controles */
        .no-print { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; display: flex; gap: 10px; align-items: center; }
        button { padding: 8px 15px; cursor: pointer; border-radius: 4px; border: 1px solid #ccc; background: white; font-weight: bold; }
        .btn-print { background: #2ecc71; color: white; border: none; }
        .btn-add { background: var(--azul-btn); color: white; border: none; }

        /* Gesti√≥n de Personal - Tabla de Base de Datos */
        .cat-card { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .tabla-personal { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .tabla-personal th { text-align: left; padding: 10px; background: #f8f9fa; border-bottom: 2px solid #dee2e6; }
        .tabla-personal td { padding: 5px; border-bottom: 1px solid #eee; }
        .tabla-personal input { width: 95%; padding: 5px; border: 1px solid transparent; background: transparent; text-transform: uppercase; }
        .tabla-personal input:focus { border-bottom: 1px solid var(--azul-btn); outline: none; background: #fff; }
        .btn-del { color: #e74c3c; border: none; background: none; font-size: 18px; cursor: pointer; }

        /* Estilo de Tabla Planilla */
        table { width: auto; min-width: 100%; border-collapse: collapse; margin-bottom: 15px; background: white; }
        .nombre-col { width: 1%; white-space: nowrap; text-align: left; padding: 0 15px 0 10px; font-weight: bold; }
        .dia-col { width: 28px; font-size: 9px; }
        .total-col { width: 38px; font-weight: 900; background: #eaeded; }
        .obs-col { width: 120px; }
        th, td { border: 1px solid #000; height: 26px; text-align: center; }
        .categoria-header { background: var(--header-bg); color: white; text-align: left; padding-left: 10px; font-size: 12px; text-transform: uppercase; }
        .festivo { background-color: var(--festivo-bg) !important; }
        [contenteditable="true"] { font-weight: bold; font-size: 13px; outline: none; }

        @media print {
            .tabs-nav, .no-print, #tab-personal { display: none !important; }
            #tab-planilla { display: block !important; padding: 0; }
            @page { size: landscape; margin: 1.5cm; }
            .total-col, .obs-col, .col-totales-header { display: none !important; }
            table { width: auto !important; margin: 0 auto !important; min-width: 0 !important; }
            .nombre-col { width: auto !important; padding-right: 40px !important; }
            .dia-col { width: 30px !important; }
            .categoria-header { -webkit-print-color-adjust: exact; }
        }
    </style>
</head>
<body>

<nav class="tabs-nav no-print">
    <button class="tab-btn active" onclick="openTab('tab-planilla')">üìã PLANILLA ASISTENCIA</button>
    <button class="tab-btn" onclick="openTab('tab-personal')">üë• GESTI√ìN DE PERSONAL</button>
</nav>

<div id="tab-planilla" class="tab-content active">
    <div class="no-print">
        <select id="mesSelect" onchange="generarTabla()"></select>
        <select id="quincenaSelect" onchange="generarTabla()">
            <option value="1">1ra Quincena</option>
            <option value="2">2da Quincena</option>
        </select>
        <button class="btn-print" onclick="window.print()">üñ®Ô∏è IMPRIMIR FORMATO</button>
    </div>
    <div id="contenedorTablas"></div>
</div>

<div id="tab-personal" class="tab-content">
    <div class="cat-card">
        <h3>A√±adir Nuevo Trabajador</h3>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <input type="text" id="nuevoNombre" placeholder="NOMBRE COMPLETO" style="width:250px; padding: 8px; text-transform: uppercase;">
            <input type="text" id="nuevaCedula" placeholder="C√âDULA" style="width:120px; padding: 8px;">
            <input type="text" id="nuevoCargo" placeholder="CARGO" style="width:150px; padding: 8px; text-transform: uppercase;">
            <input type="text" id="nuevaObra" placeholder="OBRA" style="width:150px; padding: 8px; text-transform: uppercase;">
            <select id="nuevaCat" style="padding: 8px;">
                <option value="ADMINISTRATIVOS">ADMINISTRATIVOS</option>
                <option value="OFICIALES">OFICIALES</option>
                <option value="AYUDANTES">AYUDANTES</option>
            </select>
            <button class="btn-add" onclick="agregarPersona()">+ A√ëADIR A LA LISTA</button>
        </div>
    </div>
    
    <div id="listadoPorCategorias"></div>
</div>

<script>
const estadosBase = ["", "X", "F", "P", "I", "0.5"];
const festivos2026 = ["2026-01-01","2026-01-12","2026-03-23","2026-04-02","2026-04-03","2026-05-01","2026-05-18","2026-06-08","2026-06-15","2026-06-29","2026-07-20","2026-08-07","2026-08-17","2026-10-12","2026-11-02","2026-11-16","2026-12-08","2026-12-25"];

// LISTA FIJA EN EL C√ìDIGO PARA QUE NO SE BORRE
const LISTA_MAESTRA = {
    ADMINISTRATIVOS: [
        {nombre: "JHON MICHAEL GOMEZ LEIVA", cedula: '', cargo: '', obra: ''},
        {nombre: "JAMES GOMEZ MOLINA", cedula: '', cargo: '', obra: ''},
        {nombre: "DANIEL ALEJANDRO MORENO SHAIKH", cedula: '', cargo: '', obra: ''},
        {nombre: "JOHN ALEJANDRO MORALES BIGOTT", cedula: '', cargo: '', obra: ''},
        {nombre: "MAICOL TERAN", cedula: '', cargo: '', obra: ''}
    ],
    OFICIALES: [
        {nombre: "LUIS MIGUEL DIAZ", cedula: '', cargo: '', obra: ''},
        {nombre: "JUAN CARLOS ACEVEDO RODRIGUEZ", cedula: '', cargo: '', obra: ''},
        {nombre: "ISAAC RUIZ VIDAL", cedula: '', cargo: '', obra: ''},
        {nombre: "MARVIN CAMPO", cedula: '', cargo: '', obra: ''},
        {nombre: "FABIAN MORENO", cedula: '', cargo: '', obra: ''}
    ],
    AYUDANTES: [
        {nombre: "WILMEN JOSE LORETO FERNANDEZ", cedula: '', cargo: '', obra: ''},
        {nombre: "JUAN DAVID CARDONA ABONCE", cedula: '', cargo: '', obra: ''},
        {nombre: "ARMANDO ALECIX DORADO NARVAEZ", cedula: '', cargo: '', obra: ''},
        {nombre: "LEYMAR ANDRES NAVARRO", cedula: '', cargo: '', obra: ''},
        {nombre: "HECTOR JIMENEZ", cedula: '', cargo: '', obra: ''},
        {nombre: "JUAN DAVID LOPEZ", cedula: '', cargo: '', obra: ''},
        {nombre: "JOSE MOTATO", cedula: '', cargo: '', obra: ''},
        {nombre: "JUAN RAMOS", cedula: '', cargo: '', obra: ''},
        {nombre: "JHON MARTINEZ", cedula: '', cargo: '', obra: ''},
        {nombre: "CARLOS QUINTERO", cedula: '', cargo: '', obra: ''}
    ]
};

let personal = JSON.parse(localStorage.getItem('personalObra_V2')) || LISTA_MAESTRA;

const meses = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
const diasSemana = ["Do","Lu","Ma","Mi","Ju","Vi","Sa"];

function openTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    event.currentTarget.classList.add('active');
}

function actualizarVistaPersonal() {
    const div = document.getElementById('listadoPorCategorias');
    div.innerHTML = "";
    for (let cat in personal) {
        let html = `<div class="cat-card"><h3>${cat}</h3>
            <table class="tabla-personal">
                <thead><tr><th>Nombre</th><th>C√©dula</th><th>Cargo</th><th>Obra</th><th></th></tr></thead>
                <tbody>`;
        personal[cat].forEach((p, i) => {
            html += `<tr>
                <td><input type="text" value="${p.nombre}" onchange="editarPersona('${cat}',${i},'nombre',this.value)"></td>
                <td><input type="text" value="${p.cedula}" onchange="editarPersona('${cat}',${i},'cedula',this.value)"></td>
                <td><input type="text" value="${p.cargo}" onchange="editarPersona('${cat}',${i},'cargo',this.value)"></td>
                <td><input type="text" value="${p.obra}" onchange="editarPersona('${cat}',${i},'obra',this.value)"></td>
                <td><button class="btn-del" onclick="eliminar('${cat}',${i})">üóëÔ∏è</button></td>
            </tr>`;
        });
        html += `</tbody></table></div>`;
        div.innerHTML += html;
    }
    localStorage.setItem('personalObra_V2', JSON.stringify(personal));
    generarTabla();
}

function editarPersona(cat, i, campo, valor) {
    personal[cat][i][campo] = valor.toUpperCase();
    localStorage.setItem('personalObra_V2', JSON.stringify(personal));
    generarTabla();
}

function eliminar(cat, i){ personal[cat].splice(i,1); actualizarVistaPersonal(); }

function agregarPersona(){
    const nom = document.getElementById('nuevoNombre').value;
    const cat = document.getElementById('nuevaCat').value;
    if(nom){
        personal[cat].push({
            nombre: nom.toUpperCase(),
            cedula: document.getElementById('nuevaCedula').value,
            cargo: document.getElementById('nuevoCargo').value.toUpperCase(),
            obra: document.getElementById('nuevaObra').value.toUpperCase()
        });
        document.getElementById('nuevoNombre').value="";
        document.getElementById('nuevaCedula').value="";
        document.getElementById('nuevoCargo').value="";
        document.getElementById('nuevaObra').value="";
        actualizarVistaPersonal();
    }
}

function manejarEntrada(el) {
    let val = el.innerText.toUpperCase().trim();
    if (val === "0") { el.innerText = ""; }
    else if (el.classList.contains('festivo') && (isNaN(val) || val === "X")) { el.innerText = ""; }
    else if (!el.classList.contains('festivo') && isNaN(val) && !estadosBase.includes(val)) { el.innerText = ""; }
    actualizarTotales(el.parentElement);
}

function rotar(e, el) {
    e.preventDefault();
    if (el.classList.contains('festivo')) return;
    let idx = estadosBase.indexOf(el.innerText.trim());
    idx = e.deltaY > 0 ? (idx + 1) % estadosBase.length : (idx - 1 + estadosBase.length) % estadosBase.length;
    el.innerText = estadosBase[idx];
    actualizarTotales(el.parentElement);
}

function actualizarTotales(tr) {
    let dias = 0, hed = 0, hef = 0;
    tr.querySelectorAll(".dia-col").forEach(td => {
        let v = td.innerText.trim();
        if (!td.classList.contains('festivo')) {
            if (v === "X") dias++;
            else if (v === "0.5") dias += 0.5;
            else if (v !== "" && !isNaN(v)) { 
                dias++; // Un d√≠a trabajado
                hed += parseFloat(v); // Horas extras en d√≠a normal
            }
        } else if (v !== "" && !isNaN(v)) { 
            hef += parseFloat(v); // Horas extras en festivo/domingo
        }
    });
    tr.querySelector(".c-d").innerText = dias;
    tr.querySelector(".c-hed").innerText = hed;
    tr.querySelector(".c-hef").innerText = hef;
}

function generarTabla() {
    const mes = parseInt(document.getElementById('mesSelect').value);
    const quin = document.getElementById('quincenaSelect').value;
    const inicio = quin == "1" ? 1 : 16;
    const fin = quin == "1" ? 15 : new Date(2026, mes + 1, 0).getDate();

    let html = "";
    for (let cat in personal) {
        if (personal[cat].length === 0) continue;
        html += `<table><tr><th class="categoria-header" colspan="${fin-inicio+6}">${cat}</th></tr>`;
        html += `<tr><th class="nombre-col">Trabajador</th>`;
        for (let d = inicio; d <= fin; d++) {
            let f = new Date(2026, mes, d);
            let iso = f.toISOString().split("T")[0];
            let cls = (f.getDay() == 0 || festivos2026.includes(iso)) ? "festivo" : "";
            html += `<th class="dia-col ${cls}">${d}<br>${diasSemana[f.getDay()]}</th>`;
        }
        html += `<th class="total-col col-totales-header">D</th><th class="total-col col-totales-header">HED</th><th class="total-col col-totales-header">HEF</th><th class="obs-col">Obs</th></tr>`;

        personal[cat].forEach(p => {
            html += `<tr><td class="nombre-col">${p.nombre}</td>`;
            for (let d = inicio; d <= fin; d++) {
                let f = new Date(2026, mes, d);
                let iso = f.toISOString().split("T")[0];
                let cls = (f.getDay() == 0 || festivos2026.includes(iso)) ? "festivo" : "";
                html += `<td class="dia-col ${cls}" contenteditable="true" onwheel="rotar(event, this)" onblur="manejarEntrada(this)"></td>`;
            }
            html += `<td class="total-col c-d">0</td><td class="total-col c-hed">0</td><td class="total-col c-hef">0</td><td class="obs-col"></td></tr>`;
        });
        html += `</table>`;
    }
    document.getElementById('contenedorTablas').innerHTML = html;
}

window.onload = () => {
    const mesSelect = document.getElementById('mesSelect');
    meses.forEach((m, i) => mesSelect.innerHTML += `<option value="${i}">${m}</option>`);
    actualizarVistaPersonal();
};
</script>
</body>
</html>
