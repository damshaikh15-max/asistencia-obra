<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Sistema de Asistencia de Obra - 2026</title>
    <style>
        :root { --festivo-bg: #fff9c4; --header-bg: #1a252f; --texto-negro: #000000; --azul-btn: #2196F3; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; color: var(--texto-negro); background: #f4f7f6; }
        
        .tabs-nav { background: #1a252f; padding: 10px 20px 0; display: flex; gap: 5px; }
        .tab-btn { padding: 10px 25px; border: none; background: #34495e; color: white; cursor: pointer; border-radius: 8px 8px 0 0; font-weight: bold; }
        .tab-btn.active { background: #f4f7f6; color: #1a252f; }
        .tab-content { display: none; padding: 20px; }
        .tab-content.active { display: block; }

        .no-print { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; display: flex; gap: 10px; align-items: center; }
        button { padding: 8px 15px; cursor: pointer; border-radius: 4px; border: 1px solid #ccc; font-weight: bold; }
        .btn-print { background: #2ecc71; color: white; border: none; }
        .btn-add { background: var(--azul-btn); color: white; border: none; }
        .btn-backup { background: #9b59b6; color: white; border: none; }

        .cat-card { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .tabla-personal { width: 100%; border-collapse: collapse; }
        .tabla-personal th { text-align: left; padding: 10px; background: #f8f9fa; border-bottom: 2px solid #dee2e6; }
        .tabla-personal td { padding: 5px; border-bottom: 1px solid #eee; }
        .tabla-personal input { width: 95%; padding: 5px; border: 1px solid transparent; text-transform: uppercase; }

        table.planilla { width: 100%; border-collapse: collapse; background: white; margin-bottom: 20px;}
        .nombre-col { width: 1%; white-space: nowrap; text-align: left; padding: 0 15px; font-weight: bold; font-size: 13px; }
        .dia-col { width: 30px; font-size: 10px; }
        .total-col { width: 40px; font-weight: 900; background: #eaeded; }
        th, td { border: 1px solid #000; height: 30px; text-align: center; }
        .categoria-header { background: var(--header-bg); color: white; text-align: left; padding-left: 10px; text-transform: uppercase; font-size: 14px; }
        .festivo { background-color: var(--festivo-bg) !important; }

        @media print {
            .tabs-nav, .no-print, #tab-personal { display: none !important; }
            #tab-planilla { display: block !important; padding: 0; }
            @page { size: landscape; margin: 1cm; }
            table.planilla { page-break-inside: avoid; }
        }
    </style>
</head>
<body>

<nav class="tabs-nav no-print">
    <button class="tab-btn active" onclick="openTab('tab-planilla')">üìã PLANILLA ASISTENCIA</button>
    <button class="tab-btn" onclick="openTab('tab-personal')">üë• GESTI√ìN DE PERSONAL</button>
</nav>

<div id="tab-planilla" class="tab-content active">
    <div class="no-print">
        <select id="mesSelect" onchange="generarTabla()"></select>
        <select id="quincenaSelect" onchange="generarTabla()">
            <option value="1">1ra Quincena (1-15)</option>
            <option value="2">2da Quincena (16-Fin)</option>
        </select>
        <button class="btn-print" onclick="window.print()">üñ®Ô∏è IMPRIMIR FORMATO</button>
    </div>
    <div id="contenedorTablas"></div>
</div>

<div id="tab-personal" class="tab-content">
    <div class="no-print">
        <button class="btn-backup" onclick="exportarPersonal()">üíæ GUARDAR COPIA PERSONAL</button>
        <button class="btn-backup" onclick="document.getElementById('fileInput').click()">üìÇ CARGAR COPIA PERSONAL</button>
        <input type="file" id="fileInput" style="display:none" onchange="importarPersonal(this)">
    </div>

    <div class="cat-card">
        <h3>A√±adir Nuevo Trabajador</h3>
        <div style="display: flex; gap: 10px;">
            <input type="text" id="nuevoNombre" placeholder="NOMBRE COMPLETO" style="flex-grow:1; padding: 8px; text-transform: uppercase;">
            <select id="nuevaCat" style="padding: 8px;">
                <option value="ADMINISTRATIVOS">ADMINISTRATIVOS</option>
                <option value="OFICIALES">OFICIALES</option>
                <option value="AYUDANTES">AYUDANTES</option>
            </select>
            <button class="btn-add" onclick="agregarPersona()">+ A√ëADIR A LA LISTA</button>
        </div>
    </div>
    <div id="listadoPorCategorias"></div>
</div>

<script>
const estadosBase = ["", "X", "F", "P", "I", "0.5"];
const festivos2026 = ["2026-01-01","2026-01-12","2026-03-23","2026-04-02","2026-04-03","2026-05-01","2026-05-18","2026-06-08","2026-06-15","2026-06-29","2026-07-20","2026-08-07","2026-08-17","2026-10-12","2026-11-02","2026-11-16","2026-12-08","2026-12-25"];

// --- PERSONAL FIJO GRABADO EN EL C√ìDIGO ---
const LISTA_MAESTRA = {
    ADMINISTRATIVOS: [
        {nombre: "JHON MICHAEL GOMEZ LEIVA", cedula: '', cargo: '', obra: ''},
        {nombre: "JAMES GOMEZ MOLINA", cedula: '', cargo: '', obra: ''},
        {nombre: "DANIEL ALEJANDRO MORENO SHAIKH", cedula: '', cargo: '', obra: ''},
        {nombre: "JOHN ALEJANDRO MORALES BIGOTT", cedula: '', cargo: '', obra: ''},
        {nombre: "MAICOL TERAN", cedula: '', cargo: '', obra: ''}
    ],
    OFICIALES: [
        {nombre: "LUIS MIGUEL DIAZ", cedula: '', cargo: '', obra: ''},
        {nombre: "JUAN CARLOS ACEVEDO RODRIGUEZ", cedula: '', cargo: '', obra: ''},
        {nombre: "ISAAC RUIZ VIDAL", cedula: '', cargo: '', obra: ''},
        {nombre: "MARVIN CAMPO", cedula: '', cargo: '', obra: ''},
        {nombre: "FABIAN MORENO", cedula: '', cargo: '', obra: ''}
    ],
    AYUDANTES: [
        {nombre: "WILMEN JOSE LORETO FERNANDEZ", cedula: '', cargo: '', obra: ''},
        {nombre: "JUAN DAVID CARDONA ABONCE", cedula: '', cargo: '', obra: ''},
        {nombre: "ARMANDO ALECIX DORADO NARVAEZ", cedula: '', cargo: '', obra: ''},
        {nombre: "LEYMAR ANDRES NAVARRO", cedula: '', cargo: '', obra: ''},
        {nombre: "HECTOR JIMENEZ", cedula: '', cargo: '', obra: ''},
        {nombre: "JUAN DAVID LOPEZ", cedula: '', cargo: '', obra: ''},
        {nombre: "JOSE MOTATO", cedula: '', cargo: '', obra: ''},
        {nombre: "JUAN RAMOS", cedula: '', cargo: '', obra: ''},
        {nombre: "JHON MARTINEZ", cedula: '', cargo: '', obra: ''},
        {nombre: "CARLOS QUINTERO", cedula: '', cargo: '', obra: ''}
    ]
};

// Cargar de memoria o usar la lista maestra si est√° vac√≠o
let personal = JSON.parse(localStorage.getItem('asistencia_obra_v2026_final')) || JSON.parse(JSON.stringify(LISTA_MAESTRA));

function openTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    event.currentTarget.classList.add('active');
}

function actualizarVistaPersonal() {
    const div = document.getElementById('listadoPorCategorias');
    div.innerHTML = "";
    for (let cat in personal) {
        let html = `<div class="cat-card"><h3>${cat}</h3><table class="tabla-personal"><tbody>`;
        personal[cat].forEach((p, i) => {
            html += `<tr><td><input type="text" value="${p.nombre}" onchange="editarPersona('${cat}',${i},this.value)"></td><td style="width:50px"><button onclick="eliminar('${cat}',${i})">üóëÔ∏è</button></td></tr>`;
        });
        html += `</tbody></table></div>`;
        div.innerHTML += html;
    }
    localStorage.setItem('asistencia_obra_v2026_final', JSON.stringify(personal));
    generarTabla();
}

function editarPersona(cat, i, valor) {
    personal[cat][i].nombre = valor.toUpperCase();
    localStorage.setItem('asistencia_obra_v2026_final', JSON.stringify(personal));
    generarTabla();
}

function eliminar(cat, i) { if(confirm("¬øEliminar de la lista?")) { personal[cat].splice(i, 1); actualizarVistaPersonal(); } }

function agregarPersona() {
    const nom = document.getElementById('nuevoNombre').value;
    const cat = document.getElementById('nuevaCat').value;
    if (nom) {
        personal[cat].push({ nombre: nom.toUpperCase(), cedula: '', cargo: '', obra: '' });
        document.getElementById('nuevoNombre').value = "";
        actualizarVistaPersonal();
    }
}

function exportarPersonal() {
    const blob = new Blob([JSON.stringify(personal)], {type: 'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'backup_personal_obra.json';
    a.click();
}

function importarPersonal(input) {
    const reader = new FileReader();
    reader.onload = function(){
        personal = JSON.parse(reader.result);
        actualizarVistaPersonal();
    };
    reader.readAsText(input.files[0]);
}

function actualizarTotales(tr) {
    let dias = 0, hed = 0, hef = 0;
    tr.querySelectorAll(".dia-col-input").forEach(td => {
        let v = td.innerText.trim().toUpperCase();
        if (!td.classList.contains('festivo')) {
            if (v === "X") dias++;
            else if (v === "0.5") dias += 0.5;
            else if (v !== "" && !isNaN(v)) { 
                dias++; 
                hed += parseFloat(v); 
            }
        } else if (v !== "" && !isNaN(v)) { 
            hef += parseFloat(v); 
        }
    });
    tr.querySelector(".c-d").innerText = dias;
    tr.querySelector(".c-hed").innerText = hed;
    tr.querySelector(".c-hef").innerText = hef;
}

function generarTabla() {
    const mes = parseInt(document.getElementById('mesSelect').value);
    const quin = document.getElementById('quincenaSelect').value;
    const inicio = quin == "1" ? 1 : 16;
    const fin = quin == "1" ? 15 : new Date(2026, mes + 1, 0).getDate();
    const mesesNombres = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
    const diasNombres = ["Do","Lu","Ma","Mi","Ju","Vi","Sa"];

    let html = "";
    for (let cat in personal) {
        if (personal[cat].length === 0) continue;
        html += `<table class="planilla"><tr><th class="categoria-header" colspan="${fin-inicio+5}">${cat}</th></tr><tr><th class="nombre-col">Trabajador</th>`;
        for (let d = inicio; d <= fin; d++) {
            let f = new Date(2026, mes, d);
            let cls = (f.getDay() == 0 || festivos2026.includes(f.toISOString().split("T")[0])) ? "festivo" : "";
            html += `<th class="dia-col ${cls}">${d}<br>${diasNombres[f.getDay()]}</th>`;
        }
        html += `<th class="total-col">D</th><th class="total-col">HED</th><th class="total-col">HEF</th></tr>`;
        personal[cat].forEach(p => {
            html += `<tr><td class="nombre-col">${p.nombre}</td>`;
            for (let d = inicio; d <= fin; d++) {
                let f = new Date(2026, mes, d);
                let cls = (f.getDay() == 0 || festivos2026.includes(f.toISOString().split("T")[0])) ? "festivo" : "";
                html += `<td class="dia-col dia-col-input ${cls}" contenteditable="true" onblur="actualizarTotales(this.parentElement)"></td>`;
            }
            html += `<td class="total-col c-d">0</td><td class="total-col c-hed">0</td><td class="total-col c-hef">0</td></tr>`;
        });
        html += `</table>`;
    }
    document.getElementById('contenedorTablas').innerHTML = html;
}

window.onload = () => {
    const ms = document.getElementById('mesSelect');
    ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"].forEach((m, i) => {
        ms.innerHTML += `<option value="${i}">${m}</option>`;
    });
    actualizarVistaPersonal();
};
</script>
</body>
</html>
